<style type="text/css">
	#map {
		height: 600px;
	}
</style>
<div class="col-sm-10 col-sm-offset-2 col-md-11 col-md-offset-1 main">
	<div class="page-header">
		<h3><strong>{{experiment.name}}</strong> - Map</h3>
	</div>
	<alert-messages></alert-messages>
	<div class="row">
		<div class="col-md-9" id="map"></div>
		<div class="col-md-3">
			<h3 class="text-center">Data</h3>
			<div class="form">
				<div class="form-group">
					<label for="latidud" class="col-md-3">Latitud:</label>
					<div class="col-md-9">
						<input type="number" class="inputNumber" id="latitude" class="form-control">
					</div>
				</div>
				<div class="form-group">
					<label for="longitud" class="col-md-3">Longitud:</label>
					<div class="col-md-9">
						<input type="number" class="inputNumber" id="longitude" class="form-control">
					</div>
				</div>
				<div class="text-center">
					<button class="btn btn-primary" id="setCenterButton">Set Center</button>
				</div>
			</div>
			<h3 class="text-center">Area</h3>
			<div class="form">
				<div class="form-group">
					<label for="altura" class="col-md-3">Height:</label>
					<div class="col-md-9">
						<input type="number" class="inputNumber" min="0" id="height" class="form-control" placeholder="In Meters" value="50000">
					</div>
				</div>
				<div class="form-group">
					<label for="altura" class="col-md-3">Width:</label>
					<div class="col-md-9">
						<input type="number" class="inputNumber" min="0" id="width" class="form-control" placeholder="In Meters" value="50000">
					</div>
				</div>
				<div class="text-center">
					<button class="btn btn-primary" onclick="setValues()">Set Values</button>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
function initMap() {
	var EARTH_R = 6371000;
	var marker, rectangle, center, rectangleWidth, rectangleHeight;

	var map = new google.maps.Map(document.getElementById('map'), {
		scaleControl: true,
		center: {lat: 38.981, lng: -1.856},
		zoom: 8,
		 mapTypeId: google.maps.MapTypeId.TERRAIN
	});

	map.addListener('click', function(e) {
		center = e.latLng;
		marker == undefined ? placeMarker(center, map) : moveMarker(center, map);
		$('#latitude').val(center.lat());
		$('#longitude').val(center.lng());
	});

	function placeMarker(latLng, map) {
			marker = new google.maps.Marker({
			position: latLng,
			map: map,
			draggable:true,
    		title:"Drag me!"
		});
		map.panTo(latLng);
	
	rectangle == undefined ? newRectangle(latLng) : moveRectangle(latLng) ;
	
	}

	function newRectangle(latLng){
		rectangle = new google.maps.Rectangle({
			strokeColor: '#FF0000',
			strokeOpacity: 0.6,
			strokeWeight: 2,
			fillColor: '#FF0000',
			fillOpacity: 0.2,
			editable:true,
			clickable:false,
			draggable:false,
			map: map,
			bounds: {
				north: latLng.lat() + 0.2,
				south: latLng.lat() - 0.2,
				east: latLng.lng() + 0.2,
				west: latLng.lng() - 0.2
			}
		});
		rectangle.addListener('bounds_changed', boundsChanged);
	}

	function moveRectangle(latLng){
		rectangle.setBounds({
			north: latLng.lat() + 0.2,
				south: latLng.lat() - 0.2,
				east: latLng.lng() + 0.2,
				west: latLng.lng() - 0.2
		})
	}

	function moveMarker(latLng, map) {
		marker.setPosition(latLng);
		map.panTo(latLng);
		rectangle.setBounds({
      north: displace(center.lat(), center.lng(), parseFloat($('#height').val())/2.0,0)[0],
      south: displace(center.lat(), center.lng(), parseFloat($('#height').val())/2.0,180)[0],
      east: displace(center.lat(), center.lng(), parseFloat($('#width').val())/2.0,90)[1],
      west: displace(center.lat(), center.lng(), parseFloat($('#width').val())/2.0,270)[1]
    	});
	};

	function distance(lat1, lon1, lat2, lon2) {
		var p = 0.017453292519943295;    // Math.PI / 180
		var c = Math.cos;
		var a = 0.5 - c((lat2 - lat1) * p)/2 + 
					c(lat1 * p) * c(lat2 * p) * 
					(1 - c((lon2 - lon1) * p))/2;

		return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
	}

	function boundsChanged(event){
		center = rectangle.getBounds().getCenter();
		var sw = rectangle.getBounds().getSouthWest(), ne = rectangle.getBounds().getNorthEast();
		rectangleWidth = distance(sw.lat(),sw.lng(),sw.lat(), ne.lng());
		rectangleHeight = distance(ne.lat(),ne.lng(),sw.lat(),ne.lng());
		marker.setPosition(center);
		$('#latitude').val(center.lat());
		$('#longitude').val(center.lng());
		$('#height').val(rectangleHeight);
		$('#width').val(rectangleWidth);
	}

	$('#setCenterButton').click(function(){
		if($('#latitude').val() && $('#longitude').val() && rectangle){
		center = new google.maps.LatLng({lat:parseFloat($('#latitude').val()), lng:parseFloat($('#longitude').val())});
		marker.setPosition(center);
		rectangle.setBounds({
		north: displace(center.lat(), center.lng(), parseFloat($('#height').val())/2.0,0)[0],
      south: displace(center.lat(), center.lng(), parseFloat($('#height').val())/2.0,180)[0],
      east: displace(center.lat(), center.lng(), parseFloat($('#width').val())/2.0,90)[1],
      west: displace(center.lat(), center.lng(), parseFloat($('#width').val())/2.0,270)[1]
		});
		map.panTo(center);
		}
	});

	function displace(lat, lng, dist, theta){
		var latG = lat*Math.PI/180,
		lngG = lng*Math.PI/180,
		thetaG = theta*Math.PI/180,
		delta = dist/EARTH_R;

		dstLat = Math.asin(Math.sin(latG) * Math.cos(delta) + Math.cos(latG) * Math.sin(delta) * Math.cos(thetaG));
		dstLng = lngG + Math.atan2(Math.sin(thetaG) * Math.sin(delta) * Math.cos(latG), Math.cos(delta) - Math.sin(latG) * Math.sin(dstLat));
		dstLng = (dstLng + 3.0 * Math.PI) % (2.0 * Math.PI) - Math.PI;

		return [(dstLat*180/Math.PI), (dstLng*180/Math.PI)];
	}

	function distance(lat1, lng1, lat2, lng2){
		lat1 = lat1*Math.PI/180;
		lng1 = lng1*Math.PI/180;
		lat2 = lat2*Math.PI/180;
		lng2 = lng2*Math.PI/180;
		dLat = lat2-lat1;
		dLng = lng2-lng1;

		a = Math.sin(dLat/2.0) * Math.sin(dLat/2.0) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng/2.0) * Math.sin(dLng/2.0);
		c = 2.0 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

		return EARTH_R * c;
	}
}

$(".inputNumber").keydown(function (e) {
        // Allow: backspace, delete, tab, escape, enter and .
        if ($.inArray(e.keyCode, [46, 8,109, 110, 190]) !== -1 ||
             // Allow: Ctrl+A
            (e.keyCode == 65 && e.ctrlKey === true) ||
             // Allow: Ctrl+C
            (e.keyCode == 67 && e.ctrlKey === true) ||
             // Allow: Ctrl+X
            (e.keyCode == 88 && e.ctrlKey === true) ||
             // Allow: home, end, left, right
            (e.keyCode >= 35 && e.keyCode <= 39)) {
                 // let it happen, don't do anything
                 return;
        }
        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
        }
    });
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQ4E6LnrDKzrEQtJhXpAY6bl0E9_ewKxY&callback=initMap" async
	defer></script>