var app=angular.module("Experiments",["ui.router","angularTreeview"]).controller("SidebarCtrl",["$scope","$location","$stateParams",function(a,b,c){a.links=[{name:"Overview",url:"/overview/"+c.experimentId},{name:"Labels",url:"/labels/"+c.experimentId},{name:"Input Data",url:"/inputdata/"+c.experimentId},{name:"Sources",url:"/sources/"+c.experimentId},{name:"Logs",url:"/logs/"+c.experimentId}],a.isActive=function(a){return a===b.path()}}]).controller("IndexCtrl",["$scope","$http","PanelColors",function(a,b,c){function d(){jQuery("#loadingModal").modal("show"),b.get("/experiments/list").then(function(c){a.experiments=c.data,c.data.length?b.get("/applications/list/").then(function(b){a.experiments.forEach(function(a){a.app=angular.copy(b.data.find(function(b){return b.id===a.app_id})),jQuery("#loadingModal").modal("hide")})},function(b){a.errors=b.data.errors,jQuery("#loadingModal").modal("hide")}):(jQuery("#loadingModal").modal("hide"),a.message="There is not experiments yet.")},function(b){a.errors=b.data.errors,jQuery("#loadingModal").modal("hide")})}d(),a.selectExpToDelete=function(b){a.deleteExpSelect=b},a.deleteSubmit=function(){b["delete"]("/experiments/"+a.deleteExpSelect.id).then(function(b){d(),a.message="Experiment "+a.deleteExpSelect.name+" delete successfuly."},function(b){a.errors="There is an error in the request"}),jQuery("#deleteModal").modal("hide")},a.panelColors=c}]).controller("OverviewCtrl",["$scope","$http","$stateParams","$location","PanelColors",function(a,b,c,d,e){function f(){g=window.setInterval(function(){a.refreshStatus(),(/^failed.*/.test(a.experiment.status)||"done"==a.experiment.status||"created"==a.experiment.status)&&window.clearInterval(g)},5e3)}var g,h=null;a.panelColors=e,b.get("/experiments/details/"+c.experimentId).then(function(c){a.experiment=c.data,b.get("/applications/details/"+c.data.app_id).then(function(b){a.experiment.app=b.data},function(b){a.errors=b.data.errors})},function(b){a.errors=b.data.errors}),b.get("/images/list").then(function(c){a.images=c.data,a.imageSelected=c.data[0],b.get("/sizes/list").then(function(b){h=b.data,a.getSizesOfImage()},function(b){a.errors=b.data.err})},function(b){a.errors=b.data.errors}),a.refreshStatus=function(){b.get("/experiments/details/"+c.experimentId).then(function(b){a.experiment.status=b.data.status},function(b){a.errors=b.data.errors})},a.getSizesOfImage=function(){a.coresWidth=a.imageSelected.quotas.cores.in_use/a.imageSelected.quotas.cores.limit*100,a.ramWidth=a.imageSelected.quotas.ram.in_use/a.imageSelected.quotas.ram.limit*100,a.instancesWidth=a.imageSelected.quotas.instances.in_use/a.imageSelected.quotas.instances.limit*100,a.sizes=[],h.forEach(function(b){a.imageSelected.sizes_compatible.some(function(c){if(b.id===c)return a.sizes.push(b),!0})}),a.sizes.length>0&&(a.sizeSelected=a.sizes[0])},a.launchSubmit=function(){b.post("/experiments/launch/"+a.experiment.id,{nodes:a.nodesSelected,image_id:a.imageSelected.id,size_id:a.sizeSelected.id}).then(function(b){a.message=b.data.message,f()},function(b){a.errors=b.data.errors}),jQuery("#launchModal").modal("hide"),f()},a.reset=function(){b.post("/experiments/reset/"+a.experiment.id).then(function(b){a.message=b.data.message,f()},function(b){a.errors=b.data.errors})},a.deleteSubmit=function(){b["delete"]("/experiments/"+a.experiment.id).then(function(b){jQuery("#deleteModal").modal("hide"),jQuery("#deleteModal").on("hidden.bs.modal",function(){a.$apply(function(){d.path("/")})})},function(b){a.errors="There is an error in the request"})},a.downloadResults=function(a){window.open("/experiments/downloadresults/"+a)}}]).controller("LabelsCtrl",["$scope","$http","$stateParams",function(a,b,c){a.showForm=!1,b.get("/experiments/details/"+c.experimentId).then(function(c){a.experiment=c.data,a.oldLabels=angular.copy(c.data.labels),b.get("/applications/details/"+a.experiment.app_id).then(function(b){a.experiment.app=b.data},function(b){a.errors=c.data.errors})},function(b){a.errors=b.data.errors}),a.submit=function(){for(var c in a.experiment.labels)""!==a.experiment.labels[c]&&null!==a.experiment.labels[c]||delete a.experiment.labels[c];b.put("/experiments/"+a.experiment.id,{labels:a.experiment.labels}).then(function(b){a.message="Experiment "+a.experiment.name+" updated successfully.",a.showForm=!1,a.oldLabels=angular.copy(a.experiment.labels)},function(b){a.errors="There is an error in the request."})},a.cancel=function(){a.showForm=!1,a.experiment.labels=a.oldLabels}}]).controller("CreateCtrl",["$scope","$http","$location",function(a,b,c){a.experiment={},b.get("/applications/list/").then(function(b){a.applications=b.data,a.experiment.app_id=b.data[0].id},function(b){a.errors=b.data.errors}),a.submit=function(){jQuery("#loadingModal").modal("show"),b.post("/experiments/create",a.experiment).then(function(b){jQuery("#loadingModal").modal("hide"),jQuery("#loadingModal").on("hidden.bs.modal",function(){a.$apply(function(){c.path("/overview/"+b.data.experimentId)})})},function(b){jQuery("#loadingModal").modal("hide"),a.errors=b.data.errors})}}]).controller("InputDataCtrl",["$scope","$http","$stateParams","TreeViewFunctions",function(a,b,c,d){function e(){b.get("/experiments/"+c.experimentId+"/input_tree?depth=0").then(function(b){a.experiment=b.data},function(b){a.errors=b.data.errors})}function f(d){var e="/"==d?"/experiments/"+c.experimentId+"/input_tree?depth="+depth:"/experiments/"+c.experimentId+"/input_tree?folder="+d+"&depth=0";b.get(e).then(function(b){a.experiment=b.data},function(b){a.errors=b.data.errors})}a.folderModal="",a.currentPath="/",a.currentFolder="/",a.subFolder=!1;var g=["/"];a.clearMessage=function(){a.message=null},a.clearErrorMessages=function(){a.errors=null},e(),a.folderUp=function(){g.length>1&&(g.pop(),a.currentPath=g[g.length-1],"/"===g[g.length-1]?(e(),a.subFolder=!1,a.currentFolder="/"):(f(g[g.length-1],0),a.currentFolder=d.getFolderFromPath(a.currentPath)))},a.select=function(b){(b.children.length||"/"==b.id.slice(-1))&&(g.push(b.id),a.currentPath=b.id,a.currentFolder=b.label,d.getFolderFromPath(b.id),f(b.id),a.subFolder=!0)},a.uploadFile=function(){var d="";d=a.currentPath&&"/"==a.currentPath?"/experiments/"+c.experimentId+"/input?file="+a.fileName:a.currentPath&&"/"!=a.currentPath?"/experiments/"+c.experimentId+"/input?file="+a.currentPath+a.fileName:"/experiments/"+c.experimentId+"/input?file="+a.fileName;var e=new FormData;e.append("inputFile",a.file),b.post(d,e,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function(b){f(a.currentPath),a.fileName="",a.message="Your file "+a.fileName+" has been saved succesfuly."},function(b){a.errors=b.data.errors})},a.launchCreateFolderModal=function(){jQuery("#newFolderModal").modal("show")},a.createNewFolder=function(){var d="/"==a.currentPath?"/experiments/"+c.experimentId+"/input?file="+a.folderName+"/":"/experiments/"+c.experimentId+"/input?file="+a.currentPath+a.folderName+"/";b.post(d).then(function(b){jQuery("#newFolderModal").modal("hide"),f(a.currentPath),a.folderName="",jQuery("#newFolderModal").on("hidden.bs.modal",function(){a.message="The folder "+a.currentPath+a.folderName+" has been created succesfully."})},function(b){a.errors=b.data.errors,jQuery("#newFolderModal").modal("hide")})}}]).controller("SourcesCtrl",["$scope","$http","$stateParams","TreeViewFunctions",function(a,b,c,d){function e(){b.get("/experiments/"+c.experimentId+"/src_tree?depth=0").then(function(b){a.experiment=b.data},function(b){a.errors=b.data.errors})}function f(d){var e="/"==d?"/experiments/"+c.experimentId+"/src_tree?depth="+depth:"/experiments/"+c.experimentId+"/src_tree?folder="+d+"&depth=0";b.get(e).then(function(b){a.experiment=b.data},function(b){a.errors=b.data.errors})}a.btnSaveChanges=!0,a.folderModal="",a.currentPath="/",a.currentFolder="/",a.subFolder=!1;var g=["/"];a.clearMessage=function(){a.message=null},a.clearErrorMessages=function(){a.errors=null},e(),a.select=function(c){c.children.length||"/"==c.id.slice(-1)?(g.push(c.id),a.currentPath=c.id,a.currentFolder=c.label,d.getFolderFromPath(c.id),f(c.id),a.subFolder=!0):b.get("/experiments/"+a.experiment.id+"/code?fileId="+c.id).then(function(b){a.selectedNode=c,h.setSession(ace.createEditSession(b.data,i.getModeForPath(c.label).mode))},function(b){a.errors=b.data.errors})},a.saveFile=function(c){a.btnSaveChanges&&b.post("/experiments/"+a.experiment.id+"/code?fileId="+c.id,h.getValue(),{headers:{"content-type":"text/plain"}}).then(function(b){a.message="File saved succesfully"},function(b){a.errors=b.data.errors})},a.saveNewFile=function(){if(null!==a.newFileName){var c="/"==a.currentPath?"/experiments/"+a.experiment.id+"/code?fileId="+a.newFileName:"/experiments/"+a.experiment.id+"/code?fileId="+a.currentPath+a.newFileName;b.post(c,h.getValue(),{headers:{"content-type":"text/plain"}}).then(function(a){jQuery("#newFileModal").modal("hide"),e()},function(b){jQuery("#newFileModal").modal("hide"),a.errors=b.data.errors})}},a.folderUp=function(){g.length>1&&(g.pop(),a.currentPath=g[g.length-1],"/"===g[g.length-1]?(e(),a.subFolder=!1,a.currentFolder="/"):(f(g[g.length-1]),a.currentFolder=d.getFolderFromPath(a.currentPath)))},a.launchModal=function(){a.folderModal=a.currentPath},a.launchCreateFolderModal=function(){jQuery("#newFolderModal").modal("show")},a.createNewFolder=function(){var d="/"==a.currentPath?"/experiments/"+c.experimentId+"/code?fileId="+a.folderName+"/":"/experiments/"+c.experimentId+"/code?fileId="+a.currentPath+a.folderName+"/";b.post(d).then(function(b){jQuery("#newFolderModal").modal("hide"),f(a.currentPath),a.folderName="",jQuery("#newFolderModal").on("hidden.bs.modal",function(){a.$apply(function(){a.message="The folder "+a.currentPath+a.folderName+" has been created succesfully."})})},function(b){a.errors=b.data.errors,jQuery("#newFolderModal").modal("hide")})},a.keyboardList=[{id:"hash_handler",name:"Ace"},{id:"vim",name:"vim"},{id:"emacs",name:"Emacs"}];var h=ace.edit("editor"),i=(ace.require("ace/edit_session").EditSession,ace.require("ace/ext/modelist"));a.themeList=ace.require("ace/ext/themelist").themes,a.theme=a.themeList[24],a.keyboard=a.keyboardList[0],h.setTheme(a.theme.theme),h.getSession().setMode("ace/mode/plain_text"),h.getSession().setTabSize(2),h.getSession().setUseSoftTabs(!0),h.getSession().setUseWrapMode(!0),h.setShowPrintMargin(!1),h.setHighlightActiveLine(!0),a.setKeyboardHandler=function(){h.setKeyboardHandler("ace/keyboard/"+a.keyboard.id)},a.setTheme=function(b){h.setTheme(a.theme.theme)},a.undo=function(){h.undo()},a.redo=function(){h.redo()}}]).controller("LogsCtrl",["$scope","$http","$stateParams","$location",function(a,b,c,d){var e;a.getLog=function(){e=a.selected?a.selected.name:null,b.get("/experiments/logs/"+c.experimentId).then(function(b){a.experiment=b.data,b.data.logs&&(e?a.selected=b.data.logs.find(function(a){return a.name===e}):a.selected=b.data.logs[0])},function(b){a.errors=b.data.errors})},a.getLog()}]);angular.module("Experiments").directive("alertMessages",function(a){return{restrict:"E",transclude:!0,template:'<div class="alert alert-danger col-md-10 col-md-offset-1" role="alert" ng-show="errors.length"><button type="button" class="close" data-ng-click="clearErrorMessages()" aria-label="Close"><span aria-hidden="true">&times;</span></button><p class="text-justify" ng-repeat="err in errors"><strong>Error {{err.code}}:</strong> {{err.message}}</p></div> <div class="alert alert-success text-justify col-md-10 col-md-offset-1" role="alert" ng-show="message"><button type="button" class="close" ng-click="clearMessage()"><span aria-hidden="true">&times;</span></button><p class="text-center">{{message}}</p></div>',link:function(a){a.clearMessage=function(){a.message=null},a.clearErrorMessages=function(){a.errors=null}}}});var app=angular.module("Experiments").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("index",{url:"/",views:{content:{templateUrl:"experiments/views/index.html",controller:"IndexCtrl"}}}),a.state("overview",{url:"/overview/:experimentId",views:{content:{templateUrl:"experiments/views/overview.html",controller:"OverviewCtrl"},sidebar:{controller:"SidebarCtrl",templateUrl:"experiments/views/sidebar.html"}}}),a.state("create",{url:"/create",views:{content:{templateUrl:"experiments/views/create.html",controller:"CreateCtrl"}}}),a.state("labels",{url:"/labels/:experimentId",views:{content:{templateUrl:"experiments/views/labels.html",controller:"LabelsCtrl"},sidebar:{controller:"SidebarCtrl",templateUrl:"experiments/views/sidebar.html"}}}),a.state("inputData",{url:"/inputdata/:experimentId",views:{content:{templateUrl:"experiments/views/inputdata.html",controller:"InputDataCtrl"},sidebar:{controller:"SidebarCtrl",templateUrl:"experiments/views/sidebar.html"}}}),a.state("sources",{url:"/sources/:experimentId",views:{content:{templateUrl:"experiments/views/sources.html",controller:"SourcesCtrl"},sidebar:{controller:"SidebarCtrl",templateUrl:"experiments/views/sidebar.html"}}}),a.state("logs",{url:"/logs/:experimentId",views:{content:{templateUrl:"experiments/views/logs.html",controller:"LogsCtrl"},sidebar:{controller:"SidebarCtrl",templateUrl:"experiments/views/sidebar.html"}}})}]);angular.module("Experiments").service("ExpDataService",function(){var a;return{get:function(){return a},set:function(b){a=b},clean:function(){a={}}}}).service("AppDataService",function(){var a;return{get:function(){return a},set:function(b){a=b},clean:function(){a={}}}}).service("PanelColors",function(){return{getColorClass:function(a){if(/^failed.*/.test(a))return"panel-danger";switch(a){case"done":return"panel-success";case"launched":case"compiling":case"executing":case"deployed":case"resetting":case"compiled":case"executed":return"panel-warning";case"created":return"panel-info";default:return"panel-info"}}}}).service("TreeViewFunctions",function(){function a(b){b.forEach(function(b){b.children.length>0&&(b.collapsed=!0,a(b.children))})}function b(a){var b=a.substring(0,a.length-1).split("/");return b[b.length-1]}return{addCollapsedProperty:a,getFolderFromPath:b}}).directive("fileModel",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=a(d.fileModel),f=e.assign;c.bind("change",function(){b.$apply(function(){f(b,c[0].files[0])})})}}}]);